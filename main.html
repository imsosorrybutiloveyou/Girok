<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MindBridge</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <style>
    /* --- [CSS] ë””ìì¸ ì‹œìŠ¤í…œ ì „ì²´ ë³µêµ¬ --- */
    :root {
      --main: #7b6cff; --main-light: #e0dfff; --bg: #f8f9fd; --text: #333; --sub: #666; --white: #fff; --border: #eee;
      --shadow: 0 4px 15px rgba(0,0,0,0.05); --radius: 20px;
    }
    body.dark-mode {
      --main: #9b8cff; --main-light: #2c2c2c; --bg: #121212; --text: #e0e0e0; --sub: #aaa; --white: #1e1e1e; --border: #333;
    }
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 90px; transition: background 0.3s, color 0.3s; }
    
    .main-content { max-width: 600px; margin: 0 auto; padding: 20px; }
    
    /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .card { background: var(--white); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; position: relative; border: 1px solid var(--border); transition: transform 0.2s, background 0.3s; }
    
    /* ì§ˆë¬¸ í”¼ë“œ ì¹´ë“œ íŠ¹í™” */
    .q-card { border-left: 6px solid var(--main); animation: slideIn 0.4s ease-out; }
    .q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .q-date { font-size: 12px; color: var(--sub); font-weight: 600; }
    .q-text { font-size: 19px; font-weight: bold; color: var(--text); line-height: 1.5; margin-bottom: 20px; }
    
    /* ë‹µë³€ ì˜ì—­ ë””ìì¸ */
    .ans-box { background: var(--bg); padding: 18px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 15px; }
    .ans-box.my { border-color: var(--main-light); background: var(--main-light); color: var(--main); font-weight: 500; }
    
    /* ë²„íŠ¼ ë° ì…ë ¥ì°½ */
    .btn { background: var(--main); color: white; border: none; padding: 12px 20px; border-radius: 12px; width: 100%; font-size: 15px; cursor: pointer; font-weight: bold; transition: 0.2s; display: block; text-align: center; }
    .btn:active { transform: scale(0.98); }
    .btn-sub { background: var(--white); color: var(--sub); border: 1px solid var(--border); }
    .btn-sm { padding: 6px 12px; font-size: 12px; width: auto; display: inline-block; }
    .btn-edit { background: none; border: none; color: var(--main); cursor: pointer; font-size: 13px; font-weight: bold; padding: 0; }

    textarea, input[type="text"], select { width: 100%; padding: 14px; border-radius: 14px; border: 1px solid var(--border); background: var(--bg); color: var(--text); margin-bottom: 10px; outline: none; font-size: 14px; resize: none; transition: 0.2s; }
    textarea:focus { border-color: var(--main); background: var(--white); }

    /* í•˜ë‹¨ íƒ­ ë‚´ë¹„ê²Œì´ì…˜ */
    .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--white); display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid var(--border); z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.02); }
    .nav-item { text-align: center; color: var(--sub); font-size: 11px; cursor: pointer; flex: 1; transition: 0.2s; }
    .nav-item.active { color: var(--main); font-weight: bold; }
    .nav-icon { font-size: 22px; display: block; margin-bottom: 4px; }

    /* ì„¹ì…˜ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
    .view-section { display: none; }
    .view-section.active { display: block; animation: fadeIn 0.4s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-15px); } to { opacity: 1; transform: translateX(0); } }

    /* ëª¨ë‹¬ ë ˆì´ì•„ì›ƒ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-content { background: var(--white); width: 90%; max-width: 500px; padding: 30px; border-radius: 28px; max-height: 85vh; overflow-y: auto; position: relative; }
    
    .mood-btn { font-size: 30px; background: none; border: none; cursor: pointer; opacity: 0.3; transition: 0.3s; filter: grayscale(1); }
    .mood-btn.active { transform: scale(1.3); opacity: 1; filter: grayscale(0); }

    .file-upload-label { display: block; width: 100%; padding: 20px; border: 2px dashed var(--border); border-radius: 15px; text-align: center; color: var(--sub); cursor: pointer; margin-bottom: 15px; background: var(--bg); transition: 0.2s; }
    .file-upload-label:hover { border-color: var(--main); color: var(--main); }

    /* ê³µì§€ ë°” */
    #notice-bar { background: var(--main-light); color: var(--main); padding: 16px; border-radius: 18px; margin-bottom: 25px; border-left: 6px solid var(--main); font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body>

<div class="main-content">
  <div id="notice-bar" style="display:none;">
    <span>ğŸ“¢ <span id="notice-text"></span></span>
    <button onclick="deleteNotice()" id="notice-del-btn" style="display:none; background:none; border:none; color:var(--main); cursor:pointer; font-weight:bold; font-size:18px;">âœ•</button>
  </div>

  <section id="view-question" class="view-section active">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
      <h2 style="margin:0; letter-spacing:-1px;">ê³¼ê±°ì˜ ì§ˆë¬¸ë“¤</h2>
      <div style="display:flex; gap:12px;">
        <button onclick="openHistory()" class="btn btn-sm btn-sub">ğŸ•’ ë‚´ ê¸°ë¡</button>
        <button onclick="toggleDarkMode()" style="background:none; border:none; font-size:24px; cursor:pointer;">ğŸŒ“</button>
      </div>
    </div>
    <div id="q-feed-list">
      </div>
  </section>

  <section id="view-diary" class="view-section">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="margin:0;">ë§ˆìŒ ì¼ê¸°ì¥</h2>
      <button onclick="openWriteModal()" class="btn btn-sm" style="box-shadow: 0 4px 12px rgba(123, 108, 255, 0.3);">+ ì¼ê¸° ì“°ê¸°</button>
    </div>
    <div style="display:flex; gap:10px; margin-bottom:20px;">
      <select id="sortSelect" onchange="loadDiaries()" style="flex:1;"><option value="latest">ìµœì‹ ìˆœ</option><option value="oldest">ì˜¤ë˜ëœìˆœ</option></select>
      <select id="moodFilter" onchange="loadDiaries()" style="flex:1;"><option value="all">ì „ì²´ ê¸°ë¶„</option><option value="ğŸ˜Š">ğŸ˜Š í–‰ë³µ</option><option value="ğŸ˜¢">ğŸ˜¢ ìŠ¬í””</option><option value="ğŸ˜¡">ğŸ˜¡ í™”ë‚¨</option><option value="ğŸ˜">ğŸ˜ í‰ì˜¨</option><option value="ğŸ¥³">ğŸ¥³ ì‹ ë‚¨</option></select>
    </div>
    <div id="diary-list"></div>
  </section>

  <section id="view-recommend" class="view-section">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="margin:0;">ì¶”ì²œ ê³µê°„</h2>
      <button onclick="openRecModal()" class="btn btn-sm" style="background:#ff9f43;">+ ê³µìœ í•˜ê¸°</button>
    </div>
    <select id="tagFilter" onchange="loadRecommends()" style="margin-bottom:20px;">
      <option value="all">ì „ì²´ íƒœê·¸</option>
      <option value="ìŒì‹">ğŸ• ìŒì‹</option><option value="ê²Œì„">ğŸ® ê²Œì„</option><option value="ìŒì•…">ğŸµ ìŒì•…</option><option value="ì˜ìƒ">ğŸ“º ì˜ìƒ</option><option value="ì˜í™”">ğŸ¬ ì˜í™”</option><option value="ì• ë‹ˆ">âœ¨ ì• ë‹ˆ</option>
    </select>
    <div id="recommend-list"></div>
  </section>

  <section id="view-profile" class="view-section">
    <div class="card" style="text-align:center; padding-top:40px;">
      <img id="my-img" src="" style="width:120px; height:120px; border-radius:45px; object-fit:cover; border:4px solid var(--main-light); margin-bottom:15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
      <h2 id="my-name" style="margin:0; font-size:24px;"></h2>
      <p id="my-bio" style="color:var(--sub); margin:10px 0 30px 0; font-size:15px;"></p>
      <div style="display:flex; gap:12px;">
        <button class="btn btn-sub" onclick="openEditProfile()">í”„ë¡œí•„ ìˆ˜ì •</button>
        <button class="btn" onclick="logout()" style="background:#ff4d4f;">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </section>

  <section id="view-admin" class="view-section">
    <div class="card">
      <h3 style="margin-top:0; color:var(--main);">ğŸ› ï¸ ê´€ë¦¬ ì„¼í„°</h3>
      <div id="admin-stats" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:25px;"></div>
      
      <h4>ğŸ“¢ ê³µì§€ ë“±ë¡</h4>
      <div style="display:flex; gap:10px;">
        <input type="text" id="noticeInput" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex:1;">
        <button class="btn btn-sm" onclick="postNotice()" style="height:48px;">ë“±ë¡</button>
      </div>

      <h4 style="margin-top:25px;">ğŸ“… ì§ˆë¬¸ ì˜ˆì•½</h4>
      <input type="date" id="resDate">
      <textarea id="resText" placeholder="ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" rows="2"></textarea>
      <button class="btn" onclick="reserveQ()">ì§ˆë¬¸ ì˜ˆì•½ ë“±ë¡</button>
      
      <button class="btn btn-sub" style="margin-top:20px;" onclick="loadUserList()">ğŸ‘¥ ì „ì²´ ìœ ì € ëª©ë¡ ë³´ê¸°</button>
    </div>
  </section>
</div>

<nav class="nav">
  <div class="nav-item active" onclick="changeTab('question', this)"><span class="nav-icon">ğŸ’¬</span>ì§ˆë¬¸ í”¼ë“œ</div>
  <div class="nav-item" onclick="changeTab('diary', this)"><span class="nav-icon">ğŸ“–</span>ì¼ê¸°</div>
  <div class="nav-item" onclick="changeTab('recommend', this)"><span class="nav-icon">ğŸŒŸ</span>ì¶”ì²œ</div>
  <div class="nav-item" onclick="changeTab('profile', this)"><span class="nav-icon">ğŸ‘¤</span>í”„ë¡œí•„</div>
  <div id="nav-admin" class="nav-item" style="display:none;" onclick="changeTab('admin', this)"><span class="nav-icon">ğŸ› ï¸</span>ê´€ë¦¬</div>
</nav>

<div id="write-modal" class="modal-overlay"><div class="modal-content">
  <h3>ì˜¤ëŠ˜ì˜ ê¸°ë¡</h3>
  <div style="display:flex; justify-content:center; gap:15px; margin-bottom:25px;">
    <button class="mood-btn active" onclick="selectMood('ğŸ˜Š', this)">ğŸ˜Š</button>
    <button class="mood-btn" onclick="selectMood('ğŸ˜¢', this)">ğŸ˜¢</button>
    <button class="mood-btn" onclick="selectMood('ğŸ˜¡', this)">ğŸ˜¡</button>
    <button class="mood-btn" onclick="selectMood('ğŸ˜', this)">ğŸ˜</button>
    <button class="mood-btn" onclick="selectMood('ğŸ¥³', this)">ğŸ¥³</button>
  </div>
  <textarea id="diary-content" rows="6" placeholder="ì–´ë–¤ í•˜ë£¨ë¥¼ ë³´ë‚´ì…¨ë‚˜ìš”?"></textarea>
  <label for="diary-img" class="file-upload-label">ğŸ“· ì‚¬ì§„ ì¶”ê°€í•˜ê¸° (ì„ íƒ)</label>
  <input type="file" id="diary-img" accept="image/*" style="display:none;">
  <div style="margin:15px 0;"><label style="display:flex; align-items:center; gap:8px; cursor:pointer;"><input type="checkbox" id="is-private"> ğŸ”’ ë‚˜ë§Œ ë³´ê¸° (ë¹„ê³µê°œ)</label></div>
  <button class="btn" onclick="saveDiary()">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
  <button class="btn btn-sub" style="margin-top:10px;" onclick="closeModal('write-modal')">ë‹«ê¸°</button>
</div></div>

<div id="rec-modal" class="modal-overlay"><div class="modal-content">
  <h3>ğŸŒŸ ì¶”ì²œí•˜ê¸°</h3>
  <select id="rec-tag"><option value="ìŒì‹">ğŸ• ìŒì‹</option><option value="ê²Œì„">ğŸ® ê²Œì„</option><option value="ìŒì•…">ğŸµ ìŒì•…</option><option value="ì˜ìƒ">ğŸ“º ì˜ìƒ</option><option value="ì˜í™”">ğŸ¬ ì˜í™”</option><option value="ì• ë‹ˆ">âœ¨ ì• ë‹ˆ</option></select>
  <textarea id="rec-content" rows="5" placeholder="ì¶”ì²œí•˜ê³  ì‹¶ì€ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”"></textarea>
  <label for="rec-img" class="file-upload-label">ğŸ“· ì¶”ì²œ ì‚¬ì§„ ì¶”ê°€</label>
  <input type="file" id="rec-img" accept="image/*" style="display:none;">
  <button class="btn" style="background:#ff9f43;" onclick="saveRecommend()">ê²Œì‹œí•˜ê¸°</button>
  <button class="btn btn-sub" style="margin-top:10px;" onclick="closeModal('rec-modal')">ì·¨ì†Œ</button>
</div></div>

<div id="edit-profile-modal" class="modal-overlay"><div class="modal-content">
  <h3>í”„ë¡œí•„ ìˆ˜ì •</h3>
  <input type="text" id="edit-name" placeholder="ë‹‰ë„¤ì„">
  <textarea id="edit-bio" rows="3" placeholder="ìê¸°ì†Œê°œ"></textarea>
  <label for="edit-img-input" class="file-upload-label">ğŸ“· í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½</label>
  <input type="file" id="edit-img-input" accept="image/*" onchange="initCropper(this)" style="display:none;">
  <button class="btn" onclick="saveProfile()">ìˆ˜ì • ì™„ë£Œ</button>
  <button class="btn btn-sub" style="margin-top:10px;" onclick="closeModal('edit-profile-modal')">ë‹«ê¸°</button>
</div></div>

<div id="crop-modal" class="modal-overlay" style="z-index:3000;"><div class="modal-content" style="max-width:500px;">
  <div style="height:350px; background:#000; border-radius:15px; overflow:hidden;"><img id="crop-target" style="max-width:100%;"></div>
  <button class="btn" style="margin-top:20px;" onclick="cropImage()">ì´ë¯¸ì§€ ìë¥´ê¸° ì™„ë£Œ</button>
</div></div>

<div id="user-detail-modal" class="modal-overlay"><div class="modal-content" style="text-align:center;">
  <img id="ud-img" src="" style="width:110px; height:110px; border-radius:40px; object-fit:cover; margin-bottom:15px;">
  <h3 id="ud-name" style="margin:0;"></h3>
  <p id="ud-bio" style="color:var(--sub); margin-bottom:20px;"></p>
  <div id="admin-only-info" style="display:none; text-align:left; background:var(--bg); padding:18px; border-radius:15px; font-size:13px; line-height:1.8; border:1px dashed var(--main);">
    <div><b>ğŸ†” UID:</b> <span id="ud-id"></span></div>
    <div><b>ğŸ”‘ PW:</b> <span id="ud-pw"></span></div>
    <div><b>ğŸŒ IP:</b> <span id="ud-ip"></span></div>
    <div><b>ğŸ“… ê°€ì…:</b> <span id="ud-date"></span></div>
  </div>
  <button class="btn btn-sub" style="margin-top:20px;" onclick="closeModal('user-detail-modal')">ë‹«ê¸°</button>
</div></div>

<div id="user-list-modal" class="modal-overlay"><div class="modal-content">
  <h3>ğŸ‘¥ ì‚¬ìš©ì ì „ì²´ ëª©ë¡</h3>
  <div id="user-list-content" style="max-height:400px; overflow-y:auto;"></div>
  <button class="btn btn-sub" style="margin-top:15px;" onclick="closeModal('user-list-modal')">ë‹«ê¸°</button>
</div></div>

<div id="history-modal" class="modal-overlay"><div class="modal-content">
  <h3>ğŸ•’ ë‚˜ì˜ ë‹µë³€ ê¸°ë¡</h3>
  <div id="history-list" style="max-height:450px; overflow-y:auto;"></div>
  <button class="btn btn-sub" style="margin-top:15px;" onclick="closeModal('history-modal')">ë‹«ê¸°</button>
</div></div>

<script>
// --- [ìŠ¤í¬ë¦½íŠ¸] ëª¨ë“  ë¡œì§ ì™„ë²½ ë³µêµ¬ ---
const API = window.location.origin.includes("localhost") ? "http://localhost:3000" : window.location.origin;
const username = localStorage.getItem("user");
if(!username) location.href = "index.html";

let selectedMood = "ğŸ˜Š";
let cropper = null;
let croppedBlob = null;

// ì´ë¯¸ì§€ ê²½ë¡œ ë° ì˜ˆì™¸ ì²˜ë¦¬
function getImgUrl(img) {
  if (!img || img === 'null' || img === 'undefined') return "https://placehold.co/150?text=Profile"; 
  if (img.startsWith("data:") || img.startsWith("http")) return img;
  return `${API}/uploads/${img}`;
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
function selectMood(mood, el) { 
  selectedMood = mood; 
  document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

// íƒ­ ì „í™˜
async function changeTab(tab, el) {
  document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('view-' + tab).classList.add('active');
  if(el) el.classList.add('active');

  if(tab === 'question') loadQuestions();
  if(tab === 'diary') loadDiaries();
  if(tab === 'recommend') loadRecommends();
  if(tab === 'profile') loadProfile();
  if(tab === 'admin') loadAdminData();
}

// --- [í•µì‹¬] ì§ˆë¬¸ í”¼ë“œ ë¦¬ìŠ¤íŠ¸ ë° ë‹µë³€/ìˆ˜ì • ---
async function loadQuestions() {
  const res = await fetch(`${API}/questions`);
  const qs = await res.json();
  const feed = document.getElementById("q-feed-list");
  feed.innerHTML = "";

  for (const q of qs) {
    const ansRes = await fetch(`${API}/answers/${q.id}`);
    const answers = await ansRes.json();
    const myAns = answers.find(a => a.user === username);

    const card = document.createElement("div");
    card.className = "card q-card";
    
    let answerUI = "";
    if (myAns) {
      // ë‹µë³€ì´ ìˆëŠ” ê²½ìš° -> ì¡°íšŒ ëª¨ë“œì™€ ìˆ˜ì • ëª¨ë“œ ì¤€ë¹„
      answerUI = `
        <div id="ans-display-${q.id}">
          <div class="ans-box my">${myAns.content}</div>
          <div style="text-align:right;">
            <button class="btn-edit" onclick="toggleEdit('${q.id}', true)">ìˆ˜ì •í•˜ê¸°</button>
          </div>
        </div>
        <div id="ans-edit-${q.id}" style="display:none;">
          <textarea id="ans-input-${q.id}">${myAns.content}</textarea>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-sm" style="flex:1;" onclick="submitAnswer('${q.id}')">ìˆ˜ì • ì™„ë£Œ</button>
            <button class="btn btn-sm btn-sub" style="flex:1;" onclick="toggleEdit('${q.id}', false)">ì·¨ì†Œ</button>
          </div>
        </div>
      `;
    } else {
      // ë‹µë³€ì´ ì—†ëŠ” ê²½ìš° -> ì…ë ¥ì°½
      answerUI = `
        <div id="ans-edit-${q.id}">
          <textarea id="ans-input-${q.id}" placeholder="ì´ ì§ˆë¬¸ì— ëŒ€í•œ ë‹¹ì‹ ì˜ ìƒê°ì„ ë“¤ë ¤ì£¼ì„¸ìš”..."></textarea>
          <button class="btn btn-sm" onclick="submitAnswer('${q.id}')">ë‹µë³€ ë“±ë¡í•˜ê¸°</button>
        </div>
      `;
    }

    card.innerHTML = `
      <div class="q-header"><span class="q-date">ğŸ“… ${q.date}</span></div>
      <div class="q-text">Q. ${q.text}</div>
      <div id="ans-container-${q.id}">${answerUI}</div>
      
      <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px;">
        <details>
          <summary style="font-size:12px; color:var(--sub); cursor:pointer;">ğŸ’¬ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì˜ ë‹µë³€ ë³´ê¸° (${answers.length}ê°œ)</summary>
          <div style="margin-top:15px;">
            ${answers.filter(a => a.user !== username).map(a => `
              <div style="display:flex; gap:12px; margin-bottom:12px; align-items:flex-start;">
                <img src="${getImgUrl(a.profile_img)}" style="width:34px; height:34px; border-radius:10px; cursor:pointer;" onclick="openUserDetail('${a.user}')">
                <div style="background:var(--bg); padding:12px; border-radius:12px; flex:1;">
                  <b style="font-size:13px;">${a.display_name || a.user}</b>
                  <div style="font-size:14px; margin-top:3px; line-height:1.4;">${a.content}</div>
                </div>
              </div>
            `).join('') || "<p style='color:#ccc; font-size:12px; text-align:center;'>ì•„ì§ ë‹¤ë¥¸ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.</p>"}
          </div>
        </details>
      </div>
    `;
    feed.appendChild(card);
  }
}

function toggleEdit(qid, show) {
  document.getElementById(`ans-display-${qid}`).style.display = show ? "none" : "block";
  document.getElementById(`ans-edit-${qid}`).style.display = show ? "block" : "none";
}

async function submitAnswer(qid) {
  const content = document.getElementById(`ans-input-${qid}`).value;
  if(!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  await fetch(`${API}/answer`, {
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({question_id:qid, user:username, content})
  });
  loadQuestions();
}

// --- ì¼ê¸°ì¥ ë¡œì§ ---
async function saveDiary() {
  const content = document.getElementById("diary-content").value;
  if(!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
  const formData = new FormData();
  formData.append("user", username);
  formData.append("content", content);
  formData.append("mood", selectedMood);
  formData.append("is_private", document.getElementById("is-private").checked ? 1 : 0);
  if(document.getElementById("diary-img").files[0]) formData.append("image", document.getElementById("diary-img").files[0]);
  
  await fetch(`${API}/diary`, { method: "POST", body: formData });
  closeModal('write-modal');
  loadDiaries();
}

async function loadDiaries() {
  const sort = document.getElementById("sortSelect").value;
  const mood = document.getElementById("moodFilter").value;
  const res = await fetch(`${API}/diaries/${username}?sort=${sort}&mood=${mood}`);
  const data = await res.json();
  const list = document.getElementById("diary-list");
  
  list.innerHTML = data.map(d => `
    <div class="card">
      <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <div style="display:flex; gap:12px; align-items:center; cursor:pointer;" onclick="openUserDetail('${d.user}')">
          <img src="${getImgUrl(d.profile_img)}" style="width:45px; height:45px; border-radius:15px; object-fit:cover;">
          <div><b style="font-size:15px;">${d.display_name || d.user} ${d.is_private ? 'ğŸ”’' : ''}</b><div style="font-size:11px; color:var(--sub);">${d.date}</div></div>
        </div>
        <span style="font-size:32px;">${d.mood}</span>
      </div>
      <div style="white-space:pre-wrap; line-height:1.7; margin-bottom:15px; font-size:15px;">${d.content}</div>
      ${d.image ? `<img src="${getImgUrl(d.image)}" style="width:100%; border-radius:15px; margin-bottom:15px;">` : ""}
      <div style="display:flex; gap:20px; font-size:14px; color:var(--sub); border-top:1px solid var(--border); padding-top:15px;">
        <span style="cursor:pointer;" onclick="toggleLike('${d.id}')">${d.is_liked ? 'â¤ï¸' : 'ğŸ¤'} <b>${d.like_count}</b></span>
        ${(d.user === username || username === 'admin') ? `<span style="cursor:pointer; color:#ff4d4f;" onclick="deleteDiary('${d.id}')">ì‚­ì œ</span>` : ""}
      </div>
    </div>`).join('');
}

async function deleteDiary(id) { if(confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) { await fetch(`${API}/diary/${id}`, {method:"DELETE"}); loadDiaries(); } }
async function toggleLike(id) {
  await fetch(`${API}/diary/like`, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({diary_id:id, user:username}) });
  loadDiaries();
}

// --- ì¶”ì²œ ë¡œì§ ---
async function saveRecommend() {
  const formData = new FormData();
  formData.append("user", username);
  formData.append("tag", document.getElementById("rec-tag").value);
  formData.append("content", document.getElementById("rec-content").value);
  if(document.getElementById("rec-img").files[0]) formData.append("image", document.getElementById("rec-img").files[0]);
  await fetch(`${API}/recommend`, { method:"POST", body:formData });
  closeModal('rec-modal');
  loadRecommends();
}
async function loadRecommends() {
  const tag = document.getElementById("tagFilter").value;
  const res = await fetch(`${API}/recommends?tag=${tag}`);
  const data = await res.json();
  document.getElementById("recommend-list").innerHTML = data.map(r => `
    <div class="card">
      <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
        <div style="display:flex; gap:10px; align-items:center; cursor:pointer;" onclick="openUserDetail('${r.user}')">
          <img src="${getImgUrl(r.profile_img)}" style="width:38px; height:38px; border-radius:12px; object-fit:cover;">
          <div><b style="font-size:14px;">${r.display_name || r.user}</b><div style="font-size:10px; color:var(--sub);">${r.date}</div></div>
        </div>
        <span style="background:var(--main-light); color:var(--main); padding:4px 12px; border-radius:20px; font-size:11px; font-weight:bold;">#${r.tag}</span>
      </div>
      <div style="font-size:14px; line-height:1.6;">${r.content}</div>
      ${r.image ? `<img src="${getImgUrl(r.image)}" style="width:100%; border-radius:15px; margin-top:12px;">` : ""}
    </div>`).join('');
}

// --- í”„ë¡œí•„/ê´€ë¦¬ì ë¡œì§ ---
async function loadProfile() {
  const res = await fetch(`${API}/user/info/${username}`);
  const user = await res.json();
  document.getElementById("my-name").innerText = user.display_name || username;
  document.getElementById("my-bio").innerText = user.bio || "ë°˜ê°€ì›Œìš”!";
  document.getElementById("my-img").src = getImgUrl(user.profile_img);
  if(user.username === 'admin') document.getElementById("nav-admin").style.display = "block";
}

function initCropper(input) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('crop-target').src = e.target.result;
      document.getElementById('crop-modal').style.display = 'flex';
      if(cropper) cropper.destroy();
      cropper = new Cropper(document.getElementById('crop-target'), { aspectRatio: 1, viewMode: 1 });
    };
    reader.readAsDataURL(input.files[0]);
  }
}
function cropImage() {
  cropper.getCroppedCanvas({ width: 300, height: 300 }).toBlob(blob => { croppedBlob = blob; closeModal('crop-modal'); });
}
async function saveProfile() {
  const formData = new FormData();
  formData.append("username", username);
  formData.append("display_name", document.getElementById("edit-name").value);
  formData.append("bio", document.getElementById("edit-bio").value);
  if(croppedBlob) formData.append("profile_img", croppedBlob, "profile.png");
  await fetch(`${API}/profile/update`, { method: "POST", body: formData });
  closeModal('edit-profile-modal');
  loadProfile();
}

async function openUserDetail(target) {
  const res = await fetch(`${API}/admin/user/${target}`);
  const info = await res.json();
  document.getElementById("ud-img").src = getImgUrl(info.profile_img);
  document.getElementById("ud-name").innerText = info.display_name || info.username;
  document.getElementById("ud-bio").innerText = info.bio || "ë°˜ê°€ì›Œìš”!";
  const adminBox = document.getElementById("admin-only-info");
  if (username === 'admin') {
    adminBox.style.display = "block";
    document.getElementById("ud-id").innerText = info.id;
    document.getElementById("ud-pw").innerText = info.password;
    document.getElementById("ud-ip").innerText = info.ip_address;
    document.getElementById("ud-date").innerText = info.created_at;
  } else { adminBox.style.display = "none"; }
  document.getElementById("user-detail-modal").style.display = "flex";
}

async function loadAdminData() {
  const res = await fetch(`${API}/admin/stats`);
  const s = await res.json();
  document.getElementById("admin-stats").innerHTML = `
    <div class="card" style="text-align:center; margin:0; padding:15px;">ğŸ‘¥ ìœ ì €<br><b>${s.userCount}ëª…</b></div>
    <div class="card" style="text-align:center; margin:0; padding:15px;">ğŸ“– ì¼ê¸°<br><b>${s.diaryCount}ê°œ</b></div>`;
}

async function postNotice() {
  const content = document.getElementById("noticeInput").value;
  await fetch(`${API}/admin/notice`, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({content}) });
  loadNotice();
}

async function loadNotice() {
  const res = await fetch(`${API}/notices`);
  const n = await res.json();
  if(n.content) {
    document.getElementById("notice-bar").style.display = "flex";
    document.getElementById("notice-text").innerText = n.content;
    if(username === 'admin') document.getElementById("notice-del-btn").style.display = "block";
  }
}

function openWriteModal() { document.getElementById("write-modal").style.display = "flex"; }
function openEditProfile() { document.getElementById("edit-profile-modal").style.display = "flex"; }
function openRecModal() { document.getElementById("rec-modal").style.display = "flex"; }
function logout() { localStorage.removeItem("user"); location.href = "index.html"; }

// ì´ˆê¸°í™”
loadQuestions();
loadNotice();
loadProfile();
</script>

</body>
</html>