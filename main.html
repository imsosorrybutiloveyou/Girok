<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MindBridge</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <style>
    :root {
      --main: #7b6cff; --main-light: #e0dfff; --bg: #f8f9fd; --text: #333; --sub: #666; --white: #fff; --border: #eee;
    }
    body.dark-mode {
      --main: #9b8cff; --main-light: #2c2c2c; --bg: #121212; --text: #e0e0e0; --sub: #aaa; --white: #1e1e1e; --border: #333;
    }
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 80px; transition: 0.3s; }
    header { 
      background: var(--white); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border);
    }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .card { background: var(--white); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); }
    .nav-bar {
      position: fixed; bottom: 0; width: 100%; background: var(--white); display: flex; justify-content: space-around;
      padding: 12px 0; border-top: 1px solid var(--border); z-index: 1000;
    }
    .nav-item { cursor: pointer; color: var(--sub); font-size: 12px; text-align: center; flex: 1; transition: 0.2s; }
    .nav-item.active { color: var(--main); font-weight: bold; }
    .nav-item i { font-size: 22px; display: block; margin-bottom: 4px; }
    .view-section { display: none; }
    .view-section.active { display: block; }
    .btn { background: var(--main); color: #fff; border: none; padding: 10px 18px; border-radius: 10px; cursor: pointer; width: 100%; font-size: 15px; }
    textarea { width: 100%; border: 1px solid var(--border); border-radius: 12px; padding: 15px; font-size: 15px; resize: none; min-height: 120px; margin-bottom: 10px; background: var(--bg); color: var(--text); }
    .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:2000; padding: 20px; }
    .modal-content { background:var(--white); padding:25px; border-radius:20px; width:100%; max-width:450px; position:relative; max-height: 90vh; overflow-y: auto; }
    .profile-img-big { width: 100px; height: 100px; border-radius: 35px; object-fit: cover; margin-bottom: 15px; border: 3px solid var(--main-light); }
    .mood-selector { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
    .mood-btn { padding: 8px 12px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; background: var(--white); font-size: 20px; }
    .mood-btn.active { border-color: var(--main); background: var(--main-light); }
    #notice-bar { background: var(--main-light); color: var(--main); padding: 10px 20px; font-size: 14px; display: flex; align-items: center; gap: 10px; }
    .fab { position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; border-radius: 28px; background: var(--main); color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(123, 108, 255, 0.4); cursor: pointer; z-index: 900; }
  </style>
</head>
<body>

<header>
  <h2 style="color:var(--main); margin:0;">MindBridge</h2>
  <div style="display:flex; gap:15px; align-items:center;">
    <span onclick="toggleDarkMode()" style="cursor:pointer; font-size:20px;">ğŸŒ“</span>
    <span onclick="openHistory()" style="cursor:pointer; font-size:20px;">ğŸ“œ</span>
  </div>
</header>

<div id="notice-bar" style="display:none;">
  <span>ğŸ“¢</span>
  <marquee id="notice-text" scrollamount="5"></marquee>
  <span id="notice-del-btn" onclick="deleteNotice()" style="display:none; cursor:pointer; font-size:12px;">âœ•</span>
</div>

<div class="container">
  <section id="view-question" class="view-section active">
    <div class="card" id="q-today">
      <p style="color:var(--sub);">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
  </section>

  <section id="view-diary" class="view-section">
    <div style="display:flex; gap:10px; margin-bottom:15px;">
      <select id="sortSelect" onchange="loadDiaries()" style="padding:8px; border-radius:8px; border:1px solid var(--border); flex:1;">
        <option value="latest">ìµœì‹ ìˆœ</option>
        <option value="oldest">ì˜¤ë˜ëœìˆœ</option>
      </select>
      <select id="moodFilter" onchange="loadDiaries()" style="padding:8px; border-radius:8px; border:1px solid var(--border); flex:1;">
        <option value="all">ëª¨ë“  ê¸°ë¶„</option>
        <option value="ğŸ˜Š">ğŸ˜Š í–‰ë³µ</option>
        <option value="ğŸ˜¢">ğŸ˜¢ ìŠ¬í””</option>
        <option value="ğŸ˜ ">ğŸ˜  í™”ë‚¨</option>
        <option value="ğŸ˜´">ğŸ˜´ í”¼ê³¤</option>
      </select>
    </div>
    <div id="diary-list"></div>
    <div class="fab" onclick="openWriteModal()">+</div>
  </section>

  <section id="view-recommend" class="view-section">
    <div style="margin-bottom:15px; display:flex; gap:8px; overflow-x:auto;">
      <select id="tagFilter" onchange="loadRecommends()" style="padding:8px; border-radius:8px; border:1px solid var(--border); width:100%;">
        <option value="all">ì „ì²´ íƒœê·¸</option>
        <option value="ë§›ì§‘">ë§›ì§‘</option>
        <option value="ìŒì•…">ìŒì•…</option>
        <option value="ì¥ì†Œ">ì¥ì†Œ</option>
        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
      </select>
    </div>
    <div id="recommend-list"></div>
    <div class="fab" onclick="openRecModal()" style="background:#ff6b6b; box-shadow: 0 4px 12px rgba(255,107,107,0.4);">â­</div>
  </section>

  <section id="view-profile" class="view-section">
    <div class="card" style="text-align:center;">
      <img id="my-img" class="profile-img-big" src="">
      <h3 id="my-name" style="margin:10px 0 5px;"></h3>
      <p id="my-bio" style="color:var(--sub); font-size:14px; margin-bottom:20px;"></p>
      <div style="display:flex; gap:10px;">
        <button class="btn" style="background:var(--main-light); color:var(--main);" onclick="openEditProfile()">í¸ì§‘</button>
        <button class="btn" style="background:#f1f1f1; color:#666;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </section>

  <section id="view-admin" class="view-section">
    <div class="card">
      <h3>ğŸ“Š ì„œë¹„ìŠ¤ í†µê³„</h3>
      <div id="admin-stats" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
    </div>
    <div class="card">
      <h3>ğŸ‘¤ ì‚¬ìš©ì ê´€ë¦¬</h3>
      <button class="btn" onclick="loadUserList()">ì‚¬ìš©ì ëª©ë¡ ë³´ê¸°</button>
    </div>
    <div class="card">
      <h3>ğŸ“… ì§ˆë¬¸ ì˜ˆì•½</h3>
      <input type="text" id="resText" placeholder="ì§ˆë¬¸ ë‚´ìš©" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid var(--border);">
      <input type="date" id="resDate" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid var(--border);">
      <button class="btn" onclick="reserveQ()">ì§ˆë¬¸ ë“±ë¡</button>
    </div>
    <div class="card">
      <h3>ğŸ“¢ ê³µì§€ì‚¬í•­ ê´€ë¦¬</h3>
      <textarea id="noticeInput" placeholder="ê³µì§€ ë‚´ìš©" style="min-height:80px;"></textarea>
      <button class="btn" onclick="postNotice()">ê³µì§€ ê²Œì‹œ</button>
    </div>
  </section>
</div>

<nav class="nav-bar">
  <div class="nav-item active" onclick="changeTab('question', this)"><span>â“</span>ì§ˆë¬¸</div>
  <div class="nav-item" onclick="changeTab('diary', this)"><span>ğŸ“–</span>ì¼ê¸°</div>
  <div class="nav-item" onclick="changeTab('recommend', this)"><span>âœ¨</span>ì¶”ì²œ</div>
  <div class="nav-item" onclick="changeTab('profile', this)"><span>ğŸ‘¤</span>í”„ë¡œí•„</div>
  <div class="nav-item" id="nav-admin" style="display:none;" onclick="changeTab('admin', this)"><span>âš™ï¸</span>ê´€ë¦¬</div>
</nav>

<div id="write-modal" class="modal">
  <div class="modal-content">
    <h3>ì˜¤ëŠ˜ì˜ ì¼ê¸°</h3>
    <div class="mood-selector">
      <div class="mood-btn active" onclick="selectMood('ğŸ˜Š', this)">ğŸ˜Š</div>
      <div class="mood-btn" onclick="selectMood('ğŸ˜¢', this)">ğŸ˜¢</div>
      <div class="mood-btn" onclick="selectMood('ğŸ˜ ', this)">ğŸ˜ </div>
      <div class="mood-btn" onclick="selectMood('ğŸ˜´', this)">ğŸ˜´</div>
    </div>
    <textarea id="diary-content" placeholder="ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆë‚˜ìš”?"></textarea>
    <input type="file" id="diary-img" accept="image/*" style="margin-bottom:10px;">
    <label style="display:flex; align-items:center; gap:8px; margin-bottom:15px; font-size:14px;">
      <input type="checkbox" id="is-private"> ë‚˜ë§Œ ë³´ê¸° (ë¹„ê³µê°œ)
    </label>
    <div style="display:flex; gap:10px;">
      <button class="btn" onclick="saveDiary()">ì €ì¥í•˜ê¸°</button>
      <button class="btn" style="background:#ccc" onclick="closeModal('write-modal')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<div id="user-detail-modal" class="modal">
  <div class="modal-content" style="text-align:center;">
    <img id="ud-img" class="profile-img-big" src="">
    <h3 id="ud-name" style="margin:10px 0 5px;"></h3>
    <p id="ud-bio" style="color:var(--sub); font-size:14px;"></p>
    <div id="admin-only-info" style="display:none; text-align:left; background:var(--bg); padding:15px; border-radius:12px; margin-top:15px; font-size:12px; border:1px dashed var(--main);">
      <div><b>UID:</b> <span id="ud-id"></span></div>
      <div><b>PW:</b> <span id="ud-pw"></span></div>
      <div><b>IP:</b> <span id="ud-ip"></span></div>
      <div><b>ê°€ì…:</b> <span id="ud-date"></span></div>
      <div id="ud-counts" style="margin-top:5px; font-weight:bold; color:var(--main);"></div>
    </div>
    <button class="btn" style="margin-top:20px;" onclick="closeModal('user-detail-modal')">ë‹«ê¸°</button>
  </div>
</div>

<div id="edit-profile-modal" class="modal">
  <div class="modal-content">
    <h3>í”„ë¡œí•„ í¸ì§‘</h3>
    <input type="file" id="profile-upload" accept="image/*" onchange="initCropper(this)" style="margin-bottom:15px;">
    <input type="text" id="edit-name" placeholder="ë‹‰ë„¤ì„" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid var(--border);">
    <textarea id="edit-bio" placeholder="ìê¸°ì†Œê°œ" style="min-height:80px;"></textarea>
    <div style="display:flex; gap:10px;">
      <button class="btn" onclick="saveProfile()">ì €ì¥</button>
      <button class="btn" style="background:#ccc" onclick="closeModal('edit-profile-modal')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<div id="crop-modal" class="modal" style="z-index:3000;">
  <div class="modal-content" style="max-width:500px;">
    <div style="width:100%; height:300px; background:#000;">
      <img id="crop-target" style="max-width:100%;">
    </div>
    <button class="btn" style="margin-top:15px;" onclick="cropImage()">ìë¥´ê¸° ì™„ë£Œ</button>
  </div>
</div>

<div id="history-modal" class="modal">
  <div class="modal-content">
    <h3>ë‚˜ì˜ ë‹µë³€ ê¸°ë¡</h3>
    <div id="history-list"></div>
    <button class="btn" style="margin-top:15px;" onclick="closeModal('history-modal')">ë‹«ê¸°</button>
  </div>
</div>

<div id="user-list-modal" class="modal">
  <div class="modal-content">
    <h3>ì „ì²´ ì‚¬ìš©ì ëª©ë¡</h3>
    <div id="user-list-content" style="max-height:300px; overflow-y:auto;"></div>
    <button class="btn" style="margin-top:15px;" onclick="closeModal('user-list-modal')">ë‹«ê¸°</button>
  </div>
</div>

<div id="rec-modal" class="modal">
  <div class="modal-content">
    <h3>ì¶”ì²œí•˜ê¸°</h3>
    <select id="rec-tag" style="width:100%; padding:10px; margin-bottom:10px; border-radius:10px; border:1px solid var(--border);">
      <option value="ë§›ì§‘">ğŸ˜‹ ë§›ì§‘</option>
      <option value="ìŒì•…">ğŸ§ ìŒì•…</option>
      <option value="ì¥ì†Œ">ğŸ“ ì¥ì†Œ</option>
      <option value="ê¸°íƒ€">ğŸ’¡ ê¸°íƒ€</option>
    </select>
    <textarea id="rec-content" placeholder="ë¬´ì—‡ì„ ì¶”ì²œí•˜ì‹œë‚˜ìš”?"></textarea>
    <input type="file" id="rec-img" accept="image/*" style="margin-bottom:15px;">
    <div style="display:flex; gap:10px;">
      <button class="btn" onclick="saveRecommend()">ê³µìœ í•˜ê¸°</button>
      <button class="btn" style="background:#ccc" onclick="closeModal('rec-modal')">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<script>
const API = window.location.origin.includes("localhost") ? "http://localhost:3000" : window.location.origin;
const username = localStorage.getItem("user");
if(!username) location.href = "index.html";

let selectedMood = "ğŸ˜Š";
let cropper = null;
let croppedBlob = null;

// --- ê³µí†µ ìœ í‹¸ë¦¬í‹° (ìˆ˜ì •ëœ ì´ë¯¸ì§€ í•¸ë“¤ëŸ¬) ---
function getImgUrl(img) {
  if (!img || img === "null" || img === "undefined" || img === "") {
    return "https://placehold.co/150?text=No+Image"; 
  }
  if (img.startsWith("data:") || img.startsWith("http")) return img;
  return `${API}/uploads/${img}`;
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
function selectMood(mood, el) { 
  selectedMood = mood; 
  document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

// --- íƒ­ ì´ë™ ---
async function changeTab(tab, el) {
  document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('view-' + tab).classList.add('active');
  if(el) el.classList.add('active');

  if(tab === 'question') loadQuestions();
  if(tab === 'diary') loadDiaries();
  if(tab === 'recommend') loadRecommends();
  if(tab === 'profile') loadProfile();
  if(tab === 'admin') loadAdminData();
}

// --- ì§ˆë¬¸/ë‹µë³€ ---
async function loadQuestions() {
  const res = await fetch(`${API}/questions`);
  const qs = await res.json();
  if(qs.length > 0) {
    const q = qs[0];
    document.getElementById("q-today").innerHTML = `
      <div style="font-size:12px; color:var(--sub); margin-bottom:5px;">${q.date}</div>
      <h2 style="margin:0; color:var(--main);">${q.text}</h2>
      <div id="ans-box" style="margin-top:20px;"></div>`;
    loadAnswers(q.id);
  }
}

async function loadAnswers(qid) {
  const res = await fetch(`${API}/answers/${qid}`);
  const list = await res.json();
  const myAns = list.find(a => a.user === username);
  
  let html = myAns 
    ? `<div style="background:var(--bg); padding:15px; border-radius:12px; margin-bottom:15px;"><b>ë‚˜ì˜ ë‹µë³€:</b> ${myAns.content}</div>`
    : `<textarea id="ans-input" placeholder="ìƒê°ì„ ë‚¨ê²¨ë³´ì„¸ìš”..."></textarea><button class="btn" onclick="submitAnswer('${qid}')">ë“±ë¡</button>`;
  
  html += `<h4>ë‹¤ë¥¸ ì‚¬ëŒë“¤ì˜ ë‹µë³€</h4>`;
  html += list.filter(a => a.user !== username).map(a => `
    <div style="display:flex; align-items:center; gap:8px; margin-top:12px; cursor:pointer;" onclick="openUserDetail('${a.user}')">
      <img src="${getImgUrl(a.profile_img)}" style="width:28px; height:28px; border-radius:50%; object-fit:cover;">
      <span style="font-size:14px;"><b>${a.display_name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</b>: ${a.content}</span>
    </div>`).join('') || "<p style='color:#ccc'>ì•„ì§ ë‹µë³€ì´ ì—†ì–´ìš”.</p>";
  
  document.getElementById("ans-box").innerHTML = html;
}

async function submitAnswer(qid) {
  const content = document.getElementById("ans-input").value;
  if(!content) return;
  await fetch(`${API}/answer`, {
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({question_id:qid, user:username, content})
  });
  loadAnswers(qid);
}

// --- ì¼ê¸°ì¥ ---
function openWriteModal() { document.getElementById("write-modal").style.display = "flex"; }
async function saveDiary() {
  const content = document.getElementById("diary-content").value;
  if(!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
  const formData = new FormData();
  formData.append("user", username);
  formData.append("content", content);
  formData.append("mood", selectedMood);
  formData.append("is_private", document.getElementById("is-private").checked ? 1 : 0);
  if(document.getElementById("diary-img").files[0]) formData.append("image", document.getElementById("diary-img").files[0]);
  await fetch(`${API}/diary`, { method: "POST", body: formData });
  closeModal('write-modal');
  loadDiaries();
}

async function loadDiaries() {
  const sort = document.getElementById("sortSelect").value;
  const mood = document.getElementById("moodFilter").value;
  const res = await fetch(`${API}/diaries/${username}?sort=${sort}&mood=${mood}`);
  const data = await res.json();
  const list = document.getElementById("diary-list");
  
  list.innerHTML = data.map(d => `
    <div class="card">
      <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <div style="display:flex; gap:10px; align-items:center; cursor:pointer;" onclick="openUserDetail('${d.user}')">
          <img src="${getImgUrl(d.profile_img)}" style="width:40px; height:40px; border-radius:12px; object-fit:cover;">
          <div><b>${d.display_name || 'ì•Œ ìˆ˜ ì—†ìŒ'} ${d.is_private ? 'ğŸ”’' : ''}</b><div style="font-size:11px; color:var(--sub);">${d.date}</div></div>
        </div>
        <span style="font-size:30px;">${d.mood}</span>
      </div>
      <div style="white-space:pre-wrap; line-height:1.6; margin-bottom:10px;">${d.content}</div>
      ${d.image ? `<img src="${getImgUrl(d.image)}" style="width:100%; border-radius:12px; margin-bottom:10px;">` : ""}
      <div style="display:flex; gap:15px; font-size:14px; color:var(--sub); border-top:1px solid var(--border); padding-top:10px;">
        <span style="cursor:pointer;" onclick="toggleLike('${d.id}')">${d.is_liked ? 'â¤ï¸' : 'ğŸ¤'} ${d.like_count}</span>
        ${(d.user === username || username === 'admin') ? `<span style="cursor:pointer; color:red;" onclick="deleteDiary('${d.id}')">ì‚­ì œ</span>` : ""}
      </div>
    </div>`).join('');
}

async function deleteDiary(id) { if(confirm("ì‚­ì œí• ê¹Œìš”?")) { await fetch(`${API}/diary/${id}`, {method:"DELETE"}); loadDiaries(); } }
async function toggleLike(id) {
  await fetch(`${API}/diary/like`, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({diary_id:id, user:username}) });
  loadDiaries();
}

// --- ì¶”ì²œ ---
function openRecModal() { document.getElementById("rec-modal").style.display = "flex"; }
async function saveRecommend() {
  const formData = new FormData();
  formData.append("user", username);
  formData.append("tag", document.getElementById("rec-tag").value);
  formData.append("content", document.getElementById("rec-content").value);
  if(document.getElementById("rec-img").files[0]) formData.append("image", document.getElementById("rec-img").files[0]);
  await fetch(`${API}/recommend`, { method:"POST", body:formData });
  closeModal('rec-modal');
  loadRecommends();
}
async function loadRecommends() {
  const tag = document.getElementById("tagFilter").value;
  const res = await fetch(`${API}/recommends?tag=${tag}`);
  const data = await res.json();
  document.getElementById("recommend-list").innerHTML = data.map(r => `
    <div class="card">
      <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <div style="display:flex; gap:10px; align-items:center; cursor:pointer;" onclick="openUserDetail('${r.user}')">
          <img src="${getImgUrl(r.profile_img)}" style="width:35px; height:35px; border-radius:50%; object-fit:cover;">
          <div><b>${r.display_name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</b><div style="font-size:10px; color:var(--sub);">${r.date}</div></div>
        </div>
        <span style="background:var(--main-light); color:var(--main); padding:4px 10px; border-radius:10px; font-size:12px;">#${r.tag}</span>
      </div>
      <div>${r.content}</div>
      ${r.image ? `<img src="${getImgUrl(r.image)}" style="width:100%; border-radius:12px; margin-top:10px;">` : ""}
    </div>`).join('');
}

// --- í”„ë¡œí•„ ê´€ë¦¬ ---
async function loadProfile() {
  const res = await fetch(`${API}/user/info/${username}`);
  const user = await res.json();
  document.getElementById("my-name").innerText = user.display_name || username;
  document.getElementById("my-bio").innerText = user.bio || "ë°˜ê°€ì›Œìš”!";
  document.getElementById("my-img").src = getImgUrl(user.profile_img);
  document.getElementById("edit-name").value = user.display_name || username;
  document.getElementById("edit-bio").value = user.bio || "";
}

function openEditProfile() { document.getElementById("edit-profile-modal").style.display = "flex"; }

function initCropper(input) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('crop-target').src = e.target.result;
      document.getElementById('crop-modal').style.display = 'flex';
      if(cropper) cropper.destroy();
      cropper = new Cropper(document.getElementById('crop-target'), { aspectRatio: 1, viewMode: 1 });
    };
    reader.readAsDataURL(input.files[0]);
  }
}

function cropImage() {
  cropper.getCroppedCanvas({ width: 300, height: 300 }).toBlob(blob => {
    croppedBlob = blob;
    document.getElementById('crop-modal').style.display = 'none';
  });
}

async function saveProfile() {
  const formData = new FormData();
  formData.append("username", username);
  formData.append("display_name", document.getElementById("edit-name").value);
  formData.append("bio", document.getElementById("edit-bio").value);
  if(croppedBlob) formData.append("profile_img", croppedBlob, "profile.png");
  await fetch(`${API}/profile/update`, { method: "POST", body: formData });
  closeModal('edit-profile-modal');
  loadProfile();
}

// --- [ê³ ì³ì§„ ë¶€ë¶„] ìœ ì € ìƒì„¸ ì •ë³´ ---
async function openUserDetail(target) {
  if(!target || target === 'undefined') return;
  const res = await fetch(`${API}/admin/user/${target}`);
  if(!res.ok) return; 
  const info = await res.json();
  
  // ë°ì´í„° ë°”ì¸ë”© ì‹œ undefined ë°©ì§€ (Fallback ì¶”ê°€)
  document.getElementById("ud-img").src = getImgUrl(info.profile_img);
  document.getElementById("ud-name").innerText = info.display_name || target || 'ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ì';
  document.getElementById("ud-bio").innerText = info.bio || "ë°˜ê°€ì›Œìš”!";
  
  const adminBox = document.getElementById("admin-only-info");
  if (username === 'admin') {
    adminBox.style.display = "block";
    document.getElementById("ud-id").innerText = info.id || '-';
    document.getElementById("ud-pw").innerText = info.password || '-';
    document.getElementById("ud-ip").innerText = info.ip_address || '-';
    document.getElementById("ud-date").innerText = info.created_at || '-';
    document.getElementById("ud-counts").innerText = `ì¼ê¸° ${info.diary_count || 0} / ë‹µë³€ ${info.answer_count || 0}`;
  } else {
    adminBox.style.display = "none";
  }
  document.getElementById("user-detail-modal").style.display = "flex";
}

// --- ê´€ë¦¬ì ê¸°ëŠ¥ ---
async function checkAdmin() {
  const res = await fetch(`${API}/user/info/${username}`);
  const user = await res.json();
  if(user.username === 'admin') {
    document.getElementById("nav-admin").style.display = "block";
    document.getElementById("notice-del-btn").style.display = "inline";
  }
}

async function loadAdminData() {
  const res = await fetch(`${API}/admin/stats`);
  const s = await res.json();
  document.getElementById("admin-stats").innerHTML = `
    <div style="background:var(--bg); padding:15px; border-radius:12px; text-align:center;">
      <div style="font-size:24px;">ğŸ‘¥</div>
      <div style="font-weight:bold;">${s.userCount}ëª…</div>
      <div style="font-size:11px; color:var(--sub);">ê°€ì…ì</div>
    </div>
    <div style="background:var(--bg); padding:15px; border-radius:12px; text-align:center;">
      <div style="font-size:24px;">ğŸ“–</div>
      <div style="font-weight:bold;">${s.diaryCount}ê°œ</div>
      <div style="font-size:11px; color:var(--sub);">ê¸°ë¡ë“¤</div>
    </div>`;
}

async function loadUserList() {
  const res = await fetch(`${API}/admin/users`);
  const users = await res.json();
  document.getElementById("user-list-content").innerHTML = users.map(u => `
    <div onclick="openUserDetail('${u.username}')" style="padding:12px; border-bottom:1px solid var(--border); cursor:pointer; display:flex; justify-content:space-between;">
      <span><b>${u.display_name || u.username}</b> (@${u.username})</span>
      <span style="color:var(--main); font-size:12px;">ë³´ê¸° ></span>
    </div>`).join('');
  document.getElementById("user-list-modal").style.display = "flex";
}

async function reserveQ() {
  const text = document.getElementById("resText").value;
  const date = document.getElementById("resDate").value;
  if(!text || !date) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
  await fetch(`${API}/admin/questions/reserve`, {
    method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({text, date})
  });
  alert("ì§ˆë¬¸ì´ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.");
  document.getElementById("resText").value = "";
}

async function loadNotice() {
  const res = await fetch(`${API}/notices`);
  const n = await res.json();
  if(n.content) {
    document.getElementById("notice-bar").style.display = "flex";
    document.getElementById("notice-text").innerText = n.content;
  }
}

async function postNotice() {
  const content = document.getElementById("noticeInput").value;
  if(!content) return;
  await fetch(`${API}/admin/notice`, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({content}) });
  alert("ê³µì§€ê°€ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.");
  loadNotice();
}

async function deleteNotice() {
  if(confirm("ê³µì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?")) {
    await fetch(`${API}/admin/notice/1`, { method:"DELETE" });
    document.getElementById("notice-bar").style.display = "none";
  }
}

async function openHistory() {
  const res = await fetch(`${API}/questions/history/${username}`);
  const list = await res.json();
  document.getElementById("history-list").innerHTML = list.map(h => `
    <div style="padding:15px; border-bottom:1px solid var(--border);">
      <div style="font-size:11px; color:var(--sub);">${h.q_date}</div>
      <div style="font-weight:bold; margin:5px 0;">Q. ${h.q_text}</div>
      <div style="color:var(--main); font-size:14px;">A. ${h.my_answer || 'ë¯¸ë‹µë³€'}</div>
    </div>`).join('') || "ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
  document.getElementById("history-modal").style.display = "flex";
}

function logout() { localStorage.removeItem("user"); location.href = "index.html"; }

loadQuestions();
checkAdmin();
loadNotice();
</script>
</body>
</html>