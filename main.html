<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MindBridge</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <style>
    :root {
      --main: #7b6cff; --main-light: #e0dfff; --bg: #f8f9fd; --text: #333; --sub: #666; --white: #fff; --border: #eee;
    }
    body.dark-mode {
      --main: #9b8cff; --main-light: #2c2c2c; --bg: #121212; --text: #e0e0e0; --sub: #aaa; --white: #1e1e1e; --border: #333;
    }
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 80px; transition: background 0.3s; }
    
    .main-content { max-width: 600px; margin: 0 auto; padding: 20px; }
    
    /* ì¹´ë“œ ìŠ¤íƒ€ì¼ - ì›ë˜ì˜ ì˜ˆìœ ê·¸ë¦¼ì ë³µêµ¬ */
    .card { background: var(--white); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; position: relative; border: 1px solid var(--border); }
    
    /* í•˜ë‹¨ ë‚´ë¹„ê²Œì´ì…˜ - ì›ë˜ ë””ìì¸ */
    .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--white); display: flex; justify-content: space-around; padding: 12px; border-top: 1px solid var(--border); z-index: 1000; }
    .nav-item { text-align: center; color: var(--sub); font-size: 11px; cursor: pointer; transition: 0.2s; flex: 1; }
    .nav-item.active { color: var(--main); font-weight: bold; }
    .nav-icon { font-size: 24px; display: block; margin-bottom: 4px; }
    
    /* ë²„íŠ¼ ë° ì…ë ¥ì°½ */
    .btn { background: var(--main); color: white; border: none; padding: 12px; border-radius: 12px; width: 100%; font-size: 15px; cursor: pointer; margin-top: 10px; font-weight: bold; transition: 0.2s; }
    .btn:active { transform: scale(0.98); opacity: 0.9; }
    
    .view-section { display: none; }
    .view-section.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    textarea, input[type="text"], input[type="date"], select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text); margin-bottom: 10px; outline: none; font-size: 14px; }
    
    /* ëª¨ë‹¬ ë””ìì¸ ë³µêµ¬ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
    .modal-content { background: var(--white); width: 90%; max-width: 450px; padding: 25px; border-radius: 24px; max-height: 90vh; overflow-y: auto; position: relative; }
    
    .mood-btn { font-size: 28px; background: none; border: none; cursor: pointer; opacity: 0.4; transition: 0.3s; }
    .mood-btn.active { transform: scale(1.4); opacity: 1; }
    
    .file-upload-label { display: block; width: 100%; padding: 15px; border: 2px dashed var(--border); border-radius: 12px; text-align: center; color: var(--sub); cursor: pointer; margin: 10px 0; background: var(--bg); }
    input[type="file"] { display: none; }

    /* ê³µì§€ì‚¬í•­ ë°” */
    #notice-bar { background: var(--main-light); color: var(--main); padding: 15px; border-radius: 15px; margin-bottom: 20px; border-left: 5px solid var(--main); font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body>

<div class="main-content">
  <div id="notice-bar" style="display:none;">
    <span>ğŸ“¢ <span id="notice-text"></span></span>
    <button onclick="deleteNotice()" id="notice-del-btn" style="display:none; background:none; border:none; color:var(--main); cursor:pointer; font-weight:bold;">âœ•</button>
  </div>

  <section id="view-question" class="view-section active">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="margin:0;">ì˜¤ëŠ˜ì˜ ì§ˆë¬¸</h2>
      <div style="display:flex; gap:10px;">
        <button onclick="openHistory()" style="font-size:12px; padding:6px 12px; border-radius:20px; border:1px solid var(--border); background:var(--white); cursor:pointer; color:var(--sub);">ğŸ•’ ê¸°ë¡</button>
        <button onclick="toggleDarkMode()" style="background:none; border:none; font-size:20px; cursor:pointer;">ğŸŒ“</button>
      </div>
    </div>
    <div class="card" id="q-today" style="text-align:center; padding:40px 20px;">
      <p style="color:var(--sub);">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
  </section>

  <section id="view-diary" class="view-section">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h2 style="margin:0;">ë‚˜ì˜ ì¼ê¸°ì¥</h2>
      <button onclick="openWriteModal()" style="background:var(--main); color:white; border:none; padding:10px 20px; border-radius:25px; cursor:pointer; font-weight:bold; box-shadow: 0 4px 10px rgba(123, 108, 255, 0.3);">+ ê¸€ì“°ê¸°</button>
    </div>
    <div style="display:flex; gap:10px; margin-bottom:15px;">
      <select id="sortSelect" onchange="loadDiaries()" style="margin:0;"><option value="latest">ìµœì‹ ìˆœ</option><option value="oldest">ì˜¤ë˜ëœìˆœ</option></select>
      <select id="moodFilter" onchange="loadDiaries()" style="margin:0;"><option value="all">ê¸°ë¶„ì „ì²´</option><option value="ğŸ˜Š">ğŸ˜Š í–‰ë³µ</option><option value="ğŸ˜¢">ğŸ˜¢ ìŠ¬í””</option><option value="ğŸ˜¡">ğŸ˜¡ í™”ë‚¨</option><option value="ğŸ˜">ğŸ˜ í‰ì˜¨</option><option value="ğŸ¥³">ğŸ¥³ ì‹ ë‚¨</option></select>
    </div>
    <div id="diary-list"></div>
  </section>

  <section id="view-recommend" class="view-section">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h2 style="margin:0;">ì¶”ì²œ ê³µê°„</h2>
      <button onclick="openRecModal()" style="background:#ff9f43; color:white; border:none; padding:10px 20px; border-radius:25px; cursor:pointer; font-weight:bold; box-shadow: 0 4px 10px rgba(255, 159, 67, 0.3);">+ ì¶”ì²œí•˜ê¸°</button>
    </div>
    <select id="tagFilter" onchange="loadRecommends()">
      <option value="all">ì „ì²´ íƒœê·¸</option>
      <option value="ìŒì‹">ğŸ• ìŒì‹</option><option value="ê²Œì„">ğŸ® ê²Œì„</option><option value="ìŒì•…">ğŸµ ìŒì•…</option><option value="ì˜ìƒ">ğŸ“º ì˜ìƒ</option><option value="ì˜í™”">ğŸ¬ ì˜í™”</option><option value="ì• ë‹ˆ">âœ¨ ì• ë‹ˆ</option>
    </select>
    <div id="recommend-list"></div>
  </section>

  <section id="view-profile" class="view-section">
    <div class="card" style="text-align:center; padding-top:40px;">
      <img id="my-img" src="" style="width:120px; height:120px; border-radius:45px; object-fit:cover; border:4px solid var(--main-light); margin-bottom:15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
      <h2 id="my-name" style="margin:0;"></h2>
      <p id="my-bio" style="color:var(--sub); margin:10px 0 30px 0;"></p>
      <div style="display:flex; gap:10px;">
        <button class="btn" onclick="openEditProfile()" style="background:var(--bg); color:var(--text); border:1px solid var(--border);">í”„ë¡œí•„ ìˆ˜ì •</button>
        <button class="btn" onclick="logout()" style="background:#ff4d4f; color:white;">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </section>

  <section id="view-admin" class="view-section">
    <div class="card">
      <h3 style="margin-top:0; color:var(--main);">ğŸ› ï¸ ê´€ë¦¬ì íŒ¨ë„</h3>
      <div id="admin-stats" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; background:var(--bg); padding:15px; border-radius:15px; margin-bottom:20px;"></div>
      
      <h4>ğŸ“¢ ê³µì§€ ë“±ë¡</h4>
      <div style="display:flex; gap:10px;">
        <input type="text" id="noticeInput" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="margin:0;">
        <button class="btn" onclick="postNotice()" style="margin:0; width:100px;">ë“±ë¡</button>
      </div>

      <h4 style="margin-top:25px;">ğŸ“… ì§ˆë¬¸ ì˜ˆì•½</h4>
      <input type="date" id="resDate">
      <textarea id="resText" placeholder="ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" rows="3"></textarea>
      <button class="btn" onclick="reserveQ()">ì§ˆë¬¸ ì˜ˆì•½ ë“±ë¡</button>
      
      <h4 style="margin-top:25px;">ğŸ‘¥ ìœ ì € ê´€ë¦¬</h4>
      <button class="btn" onclick="loadUserList()" style="background:var(--sub);">ì „ì²´ ìœ ì € ëª©ë¡ ë³´ê¸°</button>
    </div>
  </section>
</div>

<nav class="nav">
  <div class="nav-item active" onclick="changeTab('question', this)"><span class="nav-icon">ğŸ’¬</span>ì§ˆë¬¸</div>
  <div class="nav-item" onclick="changeTab('diary', this)"><span class="nav-icon">ğŸ“–</span>ì¼ê¸°</div>
  <div class="nav-item" onclick="changeTab('recommend', this)"><span class="nav-icon">ğŸŒŸ</span>ì¶”ì²œ</div>
  <div class="nav-item" onclick="changeTab('profile', this)"><span class="nav-icon">ğŸ‘¤</span>í”„ë¡œí•„</div>
  <div id="nav-admin" class="nav-item" style="display:none;" onclick="changeTab('admin', this)"><span class="nav-icon">ğŸ› ï¸</span>ê´€ë¦¬</div>
</nav>

<div id="write-modal" class="modal-overlay"><div class="modal-content">
  <h3>ì˜¤ëŠ˜ì˜ ê¸°ë¡</h3>
  <div style="display:flex; justify-content:center; gap:15px; margin-bottom:20px;">
    <button class="mood-btn active" onclick="selectMood('ğŸ˜Š', this)">ğŸ˜Š</button>
    <button class="mood-btn" onclick="selectMood('ğŸ˜¢', this)">ğŸ˜¢</button>
    <button class="mood-btn" onclick="selectMood('ğŸ˜¡', this)">ğŸ˜¡</button>
    <button class="mood-btn" onclick="selectMood('ğŸ˜', this)">ğŸ˜</button>
    <button class="mood-btn" onclick="selectMood('ğŸ¥³', this)">ğŸ¥³</button>
  </div>
  <textarea id="diary-content" rows="6" placeholder="ì–´ë–¤ í•˜ë£¨ë¥¼ ë³´ë‚´ì…¨ë‚˜ìš”?"></textarea>
  <label for="diary-img" class="file-upload-label">ğŸ“· ì‚¬ì§„ ì¶”ê°€í•˜ê¸°</label>
  <input type="file" id="diary-img" accept="image/*">
  <div style="margin:15px 0;"><label style="display:flex; align-items:center; gap:8px; cursor:pointer;"><input type="checkbox" id="is-private" style="width:auto; margin:0;"> ğŸ”’ ë‚˜ë§Œ ë³´ê¸° (ë¹„ê³µê°œ)</label></div>
  <button class="btn" onclick="saveDiary()">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
  <button class="btn" style="background:#eee; color:#666;" onclick="closeModal('write-modal')">ë‹«ê¸°</button>
</div></div>

<div id="rec-modal" class="modal-overlay"><div class="modal-content">
  <h3>ğŸŒŸ ì¶”ì²œí•˜ê¸°</h3>
  <select id="rec-tag"><option value="ìŒì‹">ğŸ• ìŒì‹</option><option value="ê²Œì„">ğŸ® ê²Œì„</option><option value="ìŒì•…">ğŸµ ìŒì•…</option><option value="ì˜ìƒ">ğŸ“º ì˜ìƒ</option><option value="ì˜í™”">ğŸ¬ ì˜í™”</option><option value="ì• ë‹ˆ">âœ¨ ì• ë‹ˆ</option></select>
  <textarea id="rec-content" rows="5" placeholder="ì¶”ì²œí•˜ê³  ì‹¶ì€ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”"></textarea>
  <label for="rec-img" class="file-upload-label">ğŸ“· ì¶”ì²œ ì‚¬ì§„ ì¶”ê°€</label>
  <input type="file" id="rec-img" accept="image/*">
  <button class="btn" style="background:#ff9f43;" onclick="saveRecommend()">ê²Œì‹œí•˜ê¸°</button>
  <button class="btn" style="background:#eee; color:#666;" onclick="closeModal('rec-modal')">ì·¨ì†Œ</button>
</div></div>

<div id="edit-profile-modal" class="modal-overlay"><div class="modal-content">
  <h3>í”„ë¡œí•„ ìˆ˜ì •</h3>
  <input type="text" id="edit-name" placeholder="ë‹‰ë„¤ì„">
  <textarea id="edit-bio" rows="3" placeholder="ìê¸°ì†Œê°œ"></textarea>
  <label for="edit-img-input" class="file-upload-label">ğŸ“· í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½</label>
  <input type="file" id="edit-img-input" accept="image/*" onchange="initCropper(this)">
  <button class="btn" onclick="saveProfile()">ìˆ˜ì • ì™„ë£Œ</button>
  <button class="btn" style="background:#eee; color:#666;" onclick="closeModal('edit-profile-modal')">ë‹«ê¸°</button>
</div></div>

<div id="crop-modal" class="modal-overlay" style="z-index:3000;"><div class="modal-content" style="max-width:500px;">
  <div style="height:350px; background:#000; border-radius:15px; overflow:hidden;"><img id="crop-target" style="max-width:100%;"></div>
  <button class="btn" onclick="cropImage()">ì´ë¯¸ì§€ ìë¥´ê¸° ì™„ë£Œ</button>
</div></div>

<div id="user-detail-modal" class="modal-overlay"><div class="modal-content" style="text-align:center;">
  <img id="ud-img" src="" style="width:110px; height:110px; border-radius:40px; object-fit:cover; border:4px solid var(--main-light); margin-bottom:15px;">
  <h3 id="ud-name" style="margin:0;"></h3>
  <p id="ud-bio" style="color:var(--sub); margin-bottom:20px;"></p>
  <div id="admin-only-info" style="display:none; text-align:left; background:var(--bg); padding:18px; border-radius:15px; font-size:13px; line-height:1.8; border:1px dashed var(--main);">
    <div><b>ğŸ†” UID:</b> <span id="ud-id"></span></div>
    <div><b>ğŸ”‘ PW:</b> <span id="ud-pw"></span></div>
    <div><b>ğŸŒ IP:</b> <span id="ud-ip"></span></div>
    <div><b>ğŸ“… ê°€ì…:</b> <span id="ud-date"></span></div>
    <div><b>ğŸ“Š í†µê³„:</b> <span id="ud-counts"></span></div>
  </div>
  <button class="btn" style="background:#eee; color:#666; margin-top:20px;" onclick="closeModal('user-detail-modal')">ë‹«ê¸°</button>
</div></div>

<div id="user-list-modal" class="modal-overlay"><div class="modal-content">
  <h3>ğŸ‘¥ ì‚¬ìš©ì ì „ì²´ ëª©ë¡</h3>
  <div id="user-list-content" style="max-height:400px; overflow-y:auto;"></div>
  <button class="btn" style="background:#eee; color:#666;" onclick="closeModal('user-list-modal')">ë‹«ê¸°</button>
</div></div>

<div id="history-modal" class="modal-overlay"><div class="modal-content">
  <h3>ğŸ•’ ë‚˜ì˜ ë‹µë³€ ê¸°ë¡</h3>
  <div id="history-list" style="max-height:450px; overflow-y:auto;"></div>
  <button class="btn" style="background:#eee; color:#666;" onclick="closeModal('history-modal')">ë‹«ê¸°</button>
</div></div>

<script>
// --- [ë¡œì§ í•µì‹¬] ---
const API = window.location.origin.includes("localhost") ? "http://localhost:3000" : window.location.origin;
const username = localStorage.getItem("user");
if(!username) location.href = "index.html";

let selectedMood = "ğŸ˜Š";
let cropper = null;
let croppedBlob = null;

// ì´ë¯¸ì§€ ê²½ë¡œ ë° ì˜ˆì™¸ ì²˜ë¦¬ (undefined ë°©ì§€)
function getImgUrl(img) {
  if (!img || img === 'null' || img === 'undefined') return "https://placehold.co/150?text=No+Image"; 
  if (img.startsWith("data:") || img.startsWith("http")) return img;
  return `${API}/uploads/${img}`;
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
function selectMood(mood, el) { 
  selectedMood = mood; 
  document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

// íƒ­ ì „í™˜
async function changeTab(tab, el) {
  document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('view-' + tab).classList.add('active');
  if(el) el.classList.add('active');

  if(tab === 'question') loadQuestions();
  if(tab === 'diary') loadDiaries();
  if(tab === 'recommend') loadRecommends();
  if(tab === 'profile') loadProfile();
  if(tab === 'admin') loadAdminData();
}

// ì§ˆë¬¸ê³¼ ë‹µë³€ ë¡œì§
async function loadQuestions() {
  const res = await fetch(`${API}/questions`);
  const qs = await res.json();
  if(qs.length > 0) {
    const q = qs[0];
    document.getElementById("q-today").innerHTML = `
      <div style="font-size:13px; color:var(--sub); margin-bottom:10px;">ğŸ“… ${q.date}</div>
      <h2 style="margin:0 0 25px 0; color:var(--main); line-height:1.4;">${q.text}</h2>
      <div id="ans-box"></div>`;
    loadAnswers(q.id);
  }
}

async function loadAnswers(qid) {
  const res = await fetch(`${API}/answers/${qid}`);
  const list = await res.json();
  const myAns = list.find(a => a.user === username);
  
  let html = myAns 
    ? `<div style="background:var(--main-light); color:var(--main); padding:20px; border-radius:15px; margin-bottom:20px; font-weight:500;"><b>ë‚˜ì˜ ë‹µë³€:</b> ${myAns.content}</div>`
    : `<textarea id="ans-input" placeholder="ì´ ì§ˆë¬¸ì— ëŒ€í•œ ë‹¹ì‹ ì˜ ìƒê°ì„ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea><button class="btn" onclick="submitAnswer('${qid}')">ë‹µë³€ ë“±ë¡í•˜ê¸°</button>`;
  
  html += `<h4 style="text-align:left; margin:30px 0 10px 5px;">ë‹¤ë¥¸ ì‚¬ëŒë“¤ì˜ ìƒê°</h4>`;
  html += list.filter(a => a.user !== username).map(a => `
    <div style="display:flex; align-items:flex-start; gap:12px; margin-top:15px; padding:12px; border-radius:12px; background:var(--bg); cursor:pointer;" onclick="openUserDetail('${a.user}')">
      <img src="${getImgUrl(a.profile_img)}" style="width:35px; height:35px; border-radius:12px; object-fit:cover;">
      <div style="text-align:left;"><b style="font-size:14px;">${a.display_name || a.user}</b><div style="font-size:14px; margin-top:4px; line-height:1.5;">${a.content}</div></div>
    </div>`).join('') || "<p style='color:#ccc; padding:20px;'>ì•„ì§ ë“±ë¡ëœ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
  
  document.getElementById("ans-box").innerHTML = html;
}

async function submitAnswer(qid) {
  const content = document.getElementById("ans-input").value;
  if(!content) return;
  await fetch(`${API}/answer`, {
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({question_id:qid, user:username, content})
  });
  loadAnswers(qid);
}

// ì¼ê¸° ë¡œì§
function openWriteModal() { document.getElementById("write-modal").style.display = "flex"; }
async function saveDiary() {
  const content = document.getElementById("diary-content").value;
  if(!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  const formData = new FormData();
  formData.append("user", username);
  formData.append("content", content);
  formData.append("mood", selectedMood);
  formData.append("is_private", document.getElementById("is-private").checked ? 1 : 0);
  if(document.getElementById("diary-img").files[0]) formData.append("image", document.getElementById("diary-img").files[0]);
  await fetch(`${API}/diary`, { method: "POST", body: formData });
  closeModal('write-modal');
  loadDiaries();
}

async function loadDiaries() {
  const sort = document.getElementById("sortSelect").value;
  const mood = document.getElementById("moodFilter").value;
  const res = await fetch(`${API}/diaries/${username}?sort=${sort}&mood=${mood}`);
  const data = await res.json();
  const list = document.getElementById("diary-list");
  
  list.innerHTML = data.map(d => {
    const isMine = d.user === username || username === 'admin';
    return `
    <div class="card">
      <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <div style="display:flex; gap:12px; align-items:center; cursor:pointer;" onclick="openUserDetail('${d.user}')">
          <img src="${getImgUrl(d.profile_img)}" style="width:45px; height:45px; border-radius:15px; object-fit:cover;">
          <div><b style="font-size:15px;">${d.display_name || d.user} ${d.is_private ? 'ğŸ”’' : ''}</b><div style="font-size:11px; color:var(--sub); margin-top:2px;">${d.date}</div></div>
        </div>
        <span style="font-size:32px;">${d.mood}</span>
      </div>
      <div style="white-space:pre-wrap; line-height:1.7; margin-bottom:15px; font-size:15px;">${d.content}</div>
      ${d.image ? `<img src="${getImgUrl(d.image)}" style="width:100%; border-radius:15px; margin-bottom:15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">` : ""}
      <div style="display:flex; gap:20px; font-size:14px; color:var(--sub); border-top:1px solid var(--border); padding-top:15px;">
        <span style="cursor:pointer; display:flex; align-items:center; gap:5px;" onclick="toggleLike('${d.id}')">${d.is_liked ? 'â¤ï¸' : 'ğŸ¤'} <b>${d.like_count}</b></span>
        ${isMine ? `<span style="cursor:pointer; color:#ff4d4f;" onclick="deleteDiary('${d.id}')">ì‚­ì œ</span>` : ""}
      </div>
    </div>`;
  }).join('');
}

async function deleteDiary(id) { if(confirm("ì •ë§ ì´ ì¼ê¸°ë¥¼ ì‚­ì œí• ê¹Œìš”?")) { await fetch(`${API}/diary/${id}`, {method:"DELETE"}); loadDiaries(); } }
async function toggleLike(id) {
  await fetch(`${API}/diary/like`, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({diary_id:id, user:username}) });
  loadDiaries();
}

// ì¶”ì²œ ë¡œì§
function openRecModal() { document.getElementById("rec-modal").style.display = "flex"; }
async function saveRecommend() {
  const formData = new FormData();
  formData.append("user", username);
  formData.append("tag", document.getElementById("rec-tag").value);
  formData.append("content", document.getElementById("rec-content").value);
  if(document.getElementById("rec-img").files[0]) formData.append("image", document.getElementById("rec-img").files[0]);
  await fetch(`${API}/recommend`, { method:"POST", body:formData });
  closeModal('rec-modal');
  loadRecommends();
}
async function loadRecommends() {
  const tag = document.getElementById("tagFilter").value;
  const res = await fetch(`${API}/recommends?tag=${tag}`);
  const data = await res.json();
  document.getElementById("recommend-list").innerHTML = data.map(r => `
    <div class="card">
      <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
        <div style="display:flex; gap:10px; align-items:center; cursor:pointer;" onclick="openUserDetail('${r.user}')">
          <img src="${getImgUrl(r.profile_img)}" style="width:38px; height:38px; border-radius:50%; object-fit:cover;">
          <div><b style="font-size:14px;">${r.display_name || r.user}</b><div style="font-size:10px; color:var(--sub);">${r.date}</div></div>
        </div>
        <span style="background:var(--main-light); color:var(--main); padding:4px 12px; border-radius:15px; font-size:11px; font-weight:bold;">#${r.tag}</span>
      </div>
      <div style="font-size:14px; line-height:1.6;">${r.content}</div>
      ${r.image ? `<img src="${getImgUrl(r.image)}" style="width:100%; border-radius:15px; margin-top:12px;">` : ""}
    </div>`).join('');
}

// í”„ë¡œí•„ ê´€ë¦¬
async function loadProfile() {
  const res = await fetch(`${API}/user/info/${username}`);
  const user = await res.json();
  document.getElementById("my-name").innerText = user.display_name || username;
  document.getElementById("my-bio").innerText = user.bio || "ë°˜ê°€ì›Œìš”!";
  document.getElementById("my-img").src = getImgUrl(user.profile_img);
  document.getElementById("edit-name").value = user.display_name || username;
  document.getElementById("edit-bio").value = user.bio || "";
}

function openEditProfile() { document.getElementById("edit-profile-modal").style.display = "flex"; }

function initCropper(input) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('crop-target').src = e.target.result;
      document.getElementById('crop-modal').style.display = 'flex';
      if(cropper) cropper.destroy();
      cropper = new Cropper(document.getElementById('crop-target'), { aspectRatio: 1, viewMode: 1 });
    };
    reader.readAsDataURL(input.files[0]);
  }
}

function cropImage() {
  cropper.getCroppedCanvas({ width: 300, height: 300 }).toBlob(blob => {
    croppedBlob = blob;
    document.getElementById('crop-modal').style.display = 'none';
  });
}

async function saveProfile() {
  const formData = new FormData();
  formData.append("username", username);
  formData.append("display_name", document.getElementById("edit-name").value);
  formData.append("bio", document.getElementById("edit-bio").value);
  if(croppedBlob) formData.append("profile_img", croppedBlob, "profile.png");
  await fetch(`${API}/profile/update`, { method: "POST", body: formData });
  closeModal('edit-profile-modal');
  loadProfile();
}

// ì‚¬ìš©ì ìƒì„¸ ëª¨ë‹¬ (ë°ì´í„° ê²€ì¦ ì¶”ê°€)
async function openUserDetail(target) {
  if(!target || target === 'undefined') return;
  const res = await fetch(`${API}/admin/user/${target}`);
  const info = await res.json();
  if(!info.username) return;

  document.getElementById("ud-img").src = getImgUrl(info.profile_img);
  document.getElementById("ud-name").innerText = info.display_name || info.username;
  document.getElementById("ud-bio").innerText = info.bio || "ë°˜ê°€ì›Œìš”!";
  
  const adminBox = document.getElementById("admin-only-info");
  if (username === 'admin') {
    adminBox.style.display = "block";
    document.getElementById("ud-id").innerText = info.id || '-';
    document.getElementById("ud-pw").innerText = info.password || '-';
    document.getElementById("ud-ip").innerText = info.ip_address || '-';
    document.getElementById("ud-date").innerText = info.created_at || '-';
    document.getElementById("ud-counts").innerText = `ì¼ê¸° ${info.diary_count || 0} / ë‹µë³€ ${info.answer_count || 0}`;
  } else {
    adminBox.style.display = "none";
  }
  document.getElementById("user-detail-modal").style.display = "flex";
}

// ê´€ë¦¬ììš© ê¸°ëŠ¥
async function checkAdmin() {
  const res = await fetch(`${API}/user/info/${username}`);
  const user = await res.json();
  if(user.username === 'admin') {
    document.getElementById("nav-admin").style.display = "block";
    document.getElementById("notice-del-btn").style.display = "inline";
  }
}

async function loadAdminData() {
  const res = await fetch(`${API}/admin/stats`);
  const s = await res.json();
  document.getElementById("admin-stats").innerHTML = `
    <div style="text-align:center;"><b>ğŸ‘¥ ê°€ì… ìœ ì €</b><div style="font-size:20px; color:var(--main); margin-top:5px;">${s.userCount}ëª…</div></div>
    <div style="text-align:center;"><b>ğŸ“– ì „ì²´ ì¼ê¸°</b><div style="font-size:20px; color:var(--main); margin-top:5px;">${s.diaryCount}ê°œ</div></div>`;
}

async function loadUserList() {
  const res = await fetch(`${API}/admin/users`);
  const users = await res.json();
  document.getElementById("user-list-content").innerHTML = users.map(u => `
    <div onclick="openUserDetail('${u.username}')" style="padding:15px; border-bottom:1px solid var(--border); cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
      <span><b>${u.display_name || u.username}</b> (@${u.username})</span>
      <span style="font-size:12px; color:var(--main);">ìì„¸íˆ ></span>
    </div>`).join('');
  document.getElementById("user-list-modal").style.display = "flex";
}

async function reserveQ() {
  const text = document.getElementById("resText").value;
  const date = document.getElementById("resDate").value;
  if(!text || !date) return alert("ë‚´ìš©ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
  await fetch(`${API}/admin/questions/reserve`, {
    method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({text, date})
  });
  alert("ì§ˆë¬¸ ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
  document.getElementById("resText").value = "";
}

async function loadNotice() {
  const res = await fetch(`${API}/notices`);
  const n = await res.json();
  if(n.content) {
    document.getElementById("notice-bar").style.display = "flex";
    document.getElementById("notice-text").innerText = n.content;
  }
}

async function postNotice() {
  const content = document.getElementById("noticeInput").value;
  if(!content) return;
  await fetch(`${API}/admin/notice`, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({content}) });
  alert("ê³µì§€ê°€ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.");
  document.getElementById("noticeInput").value = "";
  loadNotice();
}

async function deleteNotice() {
  if(confirm("ê³µì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?")) {
    await fetch(`${API}/admin/notice/1`, { method:"DELETE" });
    document.getElementById("notice-bar").style.display = "none";
  }
}

async function openHistory() {
  const res = await fetch(`${API}/questions/history/${username}`);
  const list = await res.json();
  document.getElementById("history-list").innerHTML = list.map(h => `
    <div class="card" style="margin-bottom:10px; padding:15px; background:var(--bg);">
      <div style="font-size:11px; color:var(--sub);">${h.q_date}</div>
      <div style="font-weight:bold; margin:8px 0;">Q. ${h.q_text}</div>
      <div style="color:var(--main); font-size:14px;">A. ${h.my_answer || 'ë‹µë³€ ê¸°ë¡ ì—†ìŒ'}</div>
    </div>`).join('') || "<p style='text-align:center; padding:20px; color:#ccc;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
  document.getElementById("history-modal").style.display = "flex";
}

function logout() { localStorage.removeItem("user"); location.href = "index.html"; }

// ì´ˆê¸°í™”
loadQuestions();
checkAdmin();
loadNotice();
</script>

</body>
</html>